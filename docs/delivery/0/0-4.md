# [0-4] Stub server + tests
[Back to task list](../tasks.md)

## Description
Implement a local stub server and associated tests to validate the rate limiter’s behavior under simulated API conditions.  
The server will respond with a configurable pattern of HTTP statuses (200, 429, 500) and optional rate-limit headers to emulate real-world throttling scenarios.

## Status History
| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-10-15 09:00:00 | Created | N/A | Proposed | Task file created | you |
| 2025-10-15 16:30:00 | Status Change | Proposed | Completed | Implemented stub server with configurable responses and 11 integration tests. All 4 test scenarios passing. | you |
| 2025-10-15 17:00:00 | Status Change | Review | Done | PR Accepted | user |

## Requirements
- Minimal async HTTP server (e.g. `aiohttp.web` or `fastapi`).
- Endpoints:
  - `/success` → returns 200 with standard `X-RateLimit-*` headers.
  - `/throttle` → returns 429 with optional `Retry-After`.
  - `/error` → returns 500.
- Ability to configure response pattern via query parameters or in-memory queue.
- Used exclusively in tests; no external dependencies required.
- Grep anchors: `# [CTX:PBI-0:0-4:STUB]`.

## Implementation Plan
- Create `tests/integration/stub_server.py` exposing configurable routes.
- Integrate into pytest fixture lifecycle (startup/shutdown).
- Use real limiter against stub endpoints to verify behavior.

## Verification (Test Plan)
- **Scenario 1:** steady requests under limit → no sleeps triggered.
- **Scenario 2:** burst causing 429 → limiter honors `Retry-After` then resumes.
- **Scenario 3:** alternating 5xx → bounded retries, eventual success/fail.
- **Scenario 4:** header-based adaptation → limiter adjusts rate dynamically.

## Files Modified
- `tests/integration/stub_server.py` (created)
- `tests/integration/test_rate_limiter.py` (created)
- `tests/integration/__init__.py` (created)
- `pyproject.toml` (added aiohttp and pytest-asyncio dependencies)

## Implementation Summary
Created a comprehensive stub server and integration test suite:

### Stub Server (`tests/integration/stub_server.py`)
- Configurable async HTTP server using aiohttp
- Queue-based response configuration
- Helper functions for common scenarios (success, throttle, error, exhausted)
- Request tracking and statistics
- Lifecycle management for pytest fixtures
- All code tagged with `[CTX:PBI-0:0-4:STUB]`

### Integration Tests (`tests/integration/test_rate_limiter.py`)
Implemented 11 integration tests across 4 test classes:

1. **TestSteadyRequests** (2 tests)
   - Verified no throttling under burst capacity
   - Tested burst capacity handling

2. **TestThrottleHandling** (3 tests)
   - 429 with Retry-After header
   - 429 without Retry-After (exponential backoff)
   - Rate limit exhaustion (remaining=0)

3. **TestErrorHandling** (3 tests)
   - 5xx with bounded retries leading to success
   - 5xx max retries enforcement
   - Non-idempotent methods not retried

4. **TestAdaptiveRate** (2 tests)
   - Rate increase based on server headers
   - Rate decrease based on server headers

5. **TestComplexScenarios** (1 test)
   - Mixed response patterns (200 → 429 → 200 → 500 → 200)

### Test Results
- All 105 tests passing (11 integration + 94 unit tests)
- Integration tests run in ~0.14s
- Full test suite runs in ~0.38s

### Dependencies Added
- `aiohttp>=3.10.0` for stub server
- `pytest-asyncio>=0.24.0` for async test support
