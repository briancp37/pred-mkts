# [0-4] Stub server + tests
[Back to task list](../tasks.md)

## Description
Implement a local stub server and associated tests to validate the rate limiter’s behavior under simulated API conditions.  
The server will respond with a configurable pattern of HTTP statuses (200, 429, 500) and optional rate-limit headers to emulate real-world throttling scenarios.

## Status History
| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-10-15 09:00:00 | Created | N/A | Proposed | Task file created | you |

## Requirements
- Minimal async HTTP server (e.g. `aiohttp.web` or `fastapi`).
- Endpoints:
  - `/success` → returns 200 with standard `X-RateLimit-*` headers.
  - `/throttle` → returns 429 with optional `Retry-After`.
  - `/error` → returns 500.
- Ability to configure response pattern via query parameters or in-memory queue.
- Used exclusively in tests; no external dependencies required.
- Grep anchors: `# [CTX:PBI-0:0-4:STUB]`.

## Implementation Plan
- Create `tests/integration/stub_server.py` exposing configurable routes.
- Integrate into pytest fixture lifecycle (startup/shutdown).
- Use real limiter against stub endpoints to verify behavior.

## Verification (Test Plan)
- **Scenario 1:** steady requests under limit → no sleeps triggered.
- **Scenario 2:** burst causing 429 → limiter honors `Retry-After` then resumes.
- **Scenario 3:** alternating 5xx → bounded retries, eventual success/fail.
- **Scenario 4:** header-based adaptation → limiter adjusts rate dynamically.

## Files Modified
- `tests/integration/test_rate_limiter.py`
- `tests/integration/stub_server.py`
