# [0-3] Header-aware rate limiter
[Back to task list](tasks.md)

## Description
Token-bucket limiter with:
- Per-host buckets (optionally per-group via config).
- **Adaptive rate**: if headers expose `limit/remaining/reset`, adjust token refill or **sleep until reset**.
- **429/Retry-After**: honor header seconds or HTTP-date; otherwise backoff (jittered exponential).
- **5xx**: bounded retries with jitter; respect idempotency.
- Concurrency gate (semaphore).

## Status History
| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-10-15 00:00:00 | Created | N/A | Proposed | Task created | User |
| 2025-10-15 01:00:00 | Status Change | Proposed | InProgress | Started implementation | AI Agent |
| 2025-10-15 02:30:00 | Status Change | InProgress | Review | Implementation complete, all 25 tests passing | AI Agent |
| 2025-10-15 03:00:00 | Status Update | Review | Done | Accepted PR | you |

## Requirements
- Grep anchors `# [CTX:PBI-0:0-3:RL]`.
- Deterministic unit tests around time via injectable clock.

## Implementation Plan
1. Create time provider abstraction (TimeProvider ABC + SystemTimeProvider)
2. Implement TokenBucket class with:
   - Token refill algorithm
   - Adaptive rate based on server headers
   - Sync with server remaining count
3. Implement RateLimiter class with:
   - Per-host token buckets
   - async acquire() / release() for concurrency control
   - Semaphore for max concurrency
   - handle_response() for 429/5xx retry logic
   - Exponential backoff with jitter
   - Retry-After header parsing (seconds and HTTP-date)
4. Implement RateLimitStats for telemetry:
   - Request counting
   - Throttle events
   - Retry counts (429 vs 5xx)
   - Moving window rate calculation
5. Create comprehensive unit tests (25 tests):
   - Token bucket algorithm
   - Adaptive rate limiting
   - 429/5xx retry logic
   - Concurrency control
   - Statistics tracking
   - Header parsing

## Verification
- Unit tests: steady rate, burst, header-driven throttling, 429 & recovery.
- All 25 rate limiter tests passing
- All 23 config tests passing
- Total 68 unit tests passing
- Deterministic testing via FakeTimeProvider

## Files Modified
- `config/limits.yml` (created) - Rate limit configuration for exchanges
- `src/pred_mkts/core/config.py` (created) - Configuration loading and validation
- `src/pred_mkts/core/rate_limiter.py` (created) - Rate limiter implementation with grep anchor [CTX:PBI-0:0-3:RL]
- `src/pred_mkts/core/__init__.py` (updated) - Export config and rate limiter classes
- `tests/unit/test_config.py` (created) - Config tests (23 tests)
- `tests/unit/test_rate_limiter.py` (created) - Rate limiter tests (25 tests)
- `pyproject.toml` (updated) - Added pytest-asyncio dependency