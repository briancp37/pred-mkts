# [0-3] Header-aware rate limiter
[Back to task list](../tasks.md)

## Description
Token-bucket limiter with:
- Per-host buckets (optionally per-group via config).
- **Adaptive rate**: if headers expose `limit/remaining/reset`, adjust token refill or **sleep until reset**.
- **429/Retry-After**: honor header seconds or HTTP-date; otherwise backoff (jittered exponential).
- **5xx**: bounded retries with jitter; respect idempotency.
- Concurrency gate (semaphore).

## Status History
| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-10-15 00:00:00 | Created | N/A | Proposed | Task created | User |
| 2025-10-15 01:00:00 | Status Change | Proposed | Review | Implementation complete, all 45 tests passing | AI Agent |

## Requirements
- Grep anchors `# [CTX:PBI-0:0-3:RL]`.
- Deterministic unit tests around time via injectable clock.

## Implementation Plan
- `RateLimiter.acquire(request_spec)` returns awaitable/sync guard.
- Track moving window statistics for telemetry.
- Pluggable time provider for tests.

## Verification
- Unit tests: steady rate, burst, header-driven throttling, 429 & recovery.
- All 45 tests passing (94 total unit tests in project)

## Implementation Summary

### Core Components
1. **TimeProvider Protocol** (`src/pred_mkts/core/rate_limiter.py`)
   - `SystemTimeProvider`: Uses real system time
   - `FakeTimeProvider`: Injectable fake time for deterministic tests
   - **CRITICAL**: Prevents time mismatch crashes by using consistent time source

2. **TokenBucket** (`src/pred_mkts/core/rate_limiter.py`)
   - Token bucket algorithm with configurable rate and capacity
   - Uses injectable TimeProvider (prevents infinite loop crash)
   - Thread-safe token consumption and refilling
   - Calculates time until tokens available

3. **RateLimiter** (`src/pred_mkts/core/rate_limiter.py`)
   - Per-host token bucket management
   - Adaptive rate adjustment from X-RateLimit-* headers
   - 429 handling with Retry-After support (seconds or HTTP-date)
   - 5xx handling with bounded exponential backoff
   - Concurrency control via semaphores (sync and async)
   - Statistics tracking for telemetry
   - Both sync (`acquire()`) and async (`acquire_async()`) context managers

### Test Coverage (45 tests)
- **TimeProvider tests** (5 tests): System time, fake time, thread safety
- **TokenBucket tests** (10 tests): Initialization, consumption, refilling, time calculations
- **RateLimiter basic tests** (7 tests): Initialization, acquisition, burst handling, stats
- **Adaptive rate tests** (5 tests): Header parsing, rate adjustment, sleep until reset
- **429 handling tests** (6 tests): Retry-After parsing, backoff, retry logic
- **5xx handling tests** (7 tests): Backoff, idempotency, bounded retries
- **Concurrency tests** (3 tests): Semaphore limits, sync and async
- **Integration tests** (2 tests): Full scenarios with burst, throttling, and recovery

## Files Modified
- `src/pred_mkts/core/rate_limiter.py` (created) - Rate limiter implementation with grep anchors
- `tests/unit/test_rate_limiter.py` (created) - Comprehensive test suite with 45 tests