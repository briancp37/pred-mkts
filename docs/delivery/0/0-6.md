# [0-6] E2E CoS test for PBI-0
[Back to task list](../tasks.md)

## Description
End-to-end test verifying the substrate and limiter together meet all Conditions of Satisfaction for PBI-0.  
Demonstrates stable throughput, adaptive throttling, and recovery from simulated 429/5xx scenarios.

## Status History
| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-10-15 09:10:00 | Created | N/A | Proposed | Task file created | you |
| 2025-10-15 09:15:00 | Status Update | Proposed | InProgress | Starting E2E test implementation | AI_Agent |
| 2025-10-15 09:45:00 | Status Update | InProgress | Review | E2E test implemented and passing | AI_Agent |

## Requirements
- Launch stub server (Task 0-4).
- Use real limiter (Task 0-3) and config (Task 0-2).
- Perform a scripted sequence of requests that:
  1. Stay below limit (no sleeps).
  2. Exceed limit → receive 429 + Retry-After → limiter pauses then resumes.
  3. Simulate adaptive headers (limit/reset) → limiter adjusts.
  4. Introduce intermittent 5xx → retries w/ backoff.
- Capture telemetry (Task 0-5) for verification.

## Implementation Plan
- Use pytest integration test under `tests/e2e/test_pbi0_e2e.py`.
- Assertions:
  - Total runtime ≈ expected from rate config.
  - No unhandled exceptions.
  - Telemetry shows correct decision sequence.
- Tag in code: `# [CTX:PBI-0:0-6:E2E]`.

## Verification (Test Plan)
- Test passes deterministically under CI.
- Logs confirm Retry-After honored and throughput restored.
- Produces artifact `artifacts/test_logs/pbi0_e2e.log` for manual inspection.

## Files Modified
- `tests/e2e/test_pbi0_e2e.py` - Complete E2E test with 4 phases
- `tests/e2e/__init__.py` - Package initialization
- `artifacts/test_logs/pbi0_e2e.log` - Test execution log

## Test Results Summary
The E2E test successfully verifies all PBI-0 Conditions of Satisfaction:

**Phase 1: Below Limit** - ✅ PASSED
- Made 5 requests within burst capacity (10 tokens)
- All completed without throttling
- Duration: < 1.0s (no rate limit delays)

**Phase 2: 429 Handling** - ✅ PASSED
- Exhausted burst capacity with 10 requests
- Triggered 429 response with Retry-After: 1s
- Limiter correctly paused and resumed after wait
- Verified 429 backoff telemetry event captured

**Phase 3: Adaptive Rate Adjustment** - ✅ PASSED
- Server returned headers indicating reduced limit (50 req/60s)
- Rate limiter adaptively adjusted internal rate
- Telemetry recorded ADAPTIVE decision events
- No rate limit violations after adjustment

**Phase 4: 5xx Error Handling** - ✅ PASSED
- Simulated 503 and 500 errors in sequence
- Limiter applied exponential backoff (0.91s, 1.24s)
- Successfully retried and completed request
- Telemetry recorded BACKOFF_5XX decision events

**Overall Results:**
- Total test duration: ~3.7s (real time)
- All requests completed successfully
- No unhandled exceptions
- Telemetry captured all decision types: ALLOW, THROTTLE, BACKOFF_429, ADAPTIVE, BACKOFF_5XX
- Rate limiter stats show correct counts for 429 and 5xx responses
- Log file generated at `artifacts/test_logs/pbi0_e2e.log`
